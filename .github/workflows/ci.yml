name: Meeting App CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    # ✅ Pass Groq key to runner
    env:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

    steps:
      # ========================
      # Checkout
      # ========================
      - uses: actions/checkout@v4

      # ========================
      # Python setup
      # ========================
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ========================
      # Install dependencies
      # ========================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ========================
      # ✅ Compile ALL files
      # catches syntax errors
      # ========================
      - name: Syntax check
        run: python -m compileall .

      # ========================
      # ✅ Import SAFE backend only
      # (NO main, NO recorder)
      # ========================
      - name: Test backend imports
        run: |
          python -c "from src import pipeline, services, chat, highlights, embed_store"

      # ========================
      # ✅ Simple pipeline smoke test
      # ========================
      - name: Pipeline smoke test
        run: |
          python - <<EOF
          from src.chunk_text import chunk_text

          sample_path = "sample.txt"
          with open(sample_path, "w") as f:
            f.write("hello world " * 50)

          chunks = chunk_text(sample_path)
          assert len(chunks) > 0
          print("Pipeline OK")
          EOF
          

      # ========================
      # Done
      # ========================
      - name: Done
        run: echo "✅ CI passed successfully"
